<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Datainsight PsyPro ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Mesmo CSS do login -->
  <link rel="stylesheet" href="assets/branding-V2.css">

  <!-- Chart.js para o gr√°fico radar -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <!-- NAVBAR -->
  <div class="navbar">
    <div class="wrap">
      <div class="logo">
        <img src="assets/datainsight.png" alt="Datainsight SST Consulting">
        <span>DATASINSIGHT PSYPRO</span>
      </div>

      <div class="navbar-right">
        <span id="userBadge" class="badge"></span>
        <button onclick="logout()" class="btn small">Sair</button>
      </div>
    </div>
  </div>

  <!-- CONTE√öDO PRINCIPAL -->
  <div class="container" style="margin-top:24px;">

    <!-- CARD ESQUERDA: Campanhas + Radar -->
    <div class="card" style="margin-bottom:24px;">
      <h2>Painel de Campanhas</h2>
      <p class="card-subtitle">
        Selecione uma campanha para visualizar o resumo das dimens√µes psicossociais.
      </p>

      <div id="status" class="small" style="margin-bottom:10px;"></div>

      <label for="campaignSelect">Campanha:</label>
      <select id="campaignSelect" onchange="onCampaignChange()">
        <option value="">Carregando campanhas...</option>
      </select>

      <!-- üîπ Aqui aparece o link p√∫blico da campanha -->
      <div id="publicLink" class="small" style="margin-top:8px;"></div>

      <h3 style="margin-top:20px;">Gr√°fico Radar (M√©dias por dimens√£o)</h3>
      <canvas id="radar" width="400" height="400"></canvas>

      <!-- üîπ Bot√£o para exportar PDF -->
      <div style="margin-top:12px;">
        <button type="button" class="btn small" onclick="exportPdf()">
          Exportar PDF
        </button>
      </div>
    </div>

    <!-- CARD DIREITA: Plano de a√ß√£o + cria√ß√£o de campanha -->
    <div class="card">
      <h2>Plano de A√ß√£o & Gest√£o</h2>
      <p class="card-subtitle">
        As dimens√µes com menor m√©dia aparecem com maior prioridade de interven√ß√£o.
      </p>

      <div id="actions" style="margin-bottom:20px;"></div>

      <hr>

      <h3>Criar nova campanha</h3>
      <form id="campaignForm" class="login-form" style="max-width:500px;">
        <label>
          Empresa / Cliente
          <input id="companyName" type="text" placeholder="Ex.: Escola Estadual X, Empresa Y" required>
        </label>

        <label>
          T√≠tulo da campanha
          <input id="campaignTitle" type="text" placeholder="Ex.: Avalia√ß√£o NR01 - 1¬∫ semestre" required>
        </label>

        <label>
          Descri√ß√£o (opcional)
          <textarea id="campaignDescription" rows="3" placeholder="Breve descri√ß√£o da campanha"></textarea>
        </label>

        <button type="submit" class="btn primary">Criar campanha</button>
      </form>
    </div>
  </div>

  <div class="footer">
    ¬© 2025 DATASINSIGHT PSYPRO ‚Äî Acesso Profissional
  </div>

  <!-- JAVASCRIPT -->
  <script>
    // URL da API em produ√ß√£o (Render)
    const API_URL = "https://datainsight-psypro.onrender.com";

    // Recupera token salvo no login
    const token = localStorage.getItem('token');

    // Se n√£o estiver logado, volta pro login
    if (!token) {
      window.location.href = "index.html";
    }

    // Gr√°fico radar (inst√¢ncia global)
    let radarChart = null;

    // Ao carregar a p√°gina
    document.addEventListener("DOMContentLoaded", () => {
      const userName = localStorage.getItem('user_name') || "Usu√°rio";
      const badge = document.getElementById("userBadge");
      if (badge) {
        badge.textContent = userName;
      }

      // Liga o formul√°rio de nova campanha
      const form = document.getElementById("campaignForm");
      if (form) {
        form.addEventListener("submit", onCreateCampaign);
      }

      // Carrega campanhas ao abrir
      loadCampaigns();
    });

    // Bot√£o de sair
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user_name');
      window.location.href = "index.html";
    }

    // Mostra mensagenzinha de status
    function setStatus(msg) {
      const el = document.getElementById("status");
      if (el) el.textContent = msg;
    }

    // üîπ Mostra o link p√∫blico da campanha selecionada
    async function showPublicLink(campaignId) {
      const el = document.getElementById("publicLink");
      if (!el) return;

      if (!campaignId) {
        el.textContent = "";
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/public/surveys/${campaignId}/link`);
        if (!res.ok) {
          el.textContent = "N√£o foi poss√≠vel gerar o link p√∫blico.";
          return;
        }
        const data = await res.json();
        el.innerHTML = `Link p√∫blico: <a href="${data.url}" target="_blank">${data.url}</a>`;
      } catch (err) {
        console.error(err);
        el.textContent = "Erro ao carregar link p√∫blico.";
      }
    }

    // 1) Carregar lista de campanhas
    async function loadCampaigns() {
      setStatus("Carregando campanhas...");

      try {
        const res = await fetch(`${API_URL}/api/campaigns`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          setStatus("Erro ao carregar campanhas. Talvez o login tenha expirado.");
          return;
        }

        const campaigns = await res.json();
        const select = document.getElementById("campaignSelect");

        if (!select) return;

        select.innerHTML = "";

        if (campaigns.length === 0) {
          setStatus("Nenhuma campanha cadastrada ainda.");
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Nenhuma campanha dispon√≠vel";
          select.appendChild(opt);

          document.getElementById("actions").innerHTML =
            "<p class='small'>Cadastre uma campanha no formul√°rio abaixo para come√ßar.</p>";

          // limpa radar e link p√∫blico
          renderRadarChart([], []);
          showPublicLink(null);
          return;
        }

        setStatus(`Foram encontradas ${campaigns.length} campanha(s).`);

        campaigns.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.company_name} ‚Äî ${c.title}`;
          select.appendChild(opt);
        });

        // Carrega a primeira campanha automaticamente
        const firstId = campaigns[0].id;
        loadSummary(firstId);
        showPublicLink(firstId);
      } catch (err) {
        console.error(err);
        setStatus("Erro de conex√£o com o servidor. Verifique a API_URL.");
      }
    }

    // 2) Quando trocar a campanha no select
    async function onCampaignChange() {
      const select = document.getElementById("campaignSelect");
      if (!select || !select.value) {
        showPublicLink(null);
        return;
      }
      await loadSummary(select.value);
      showPublicLink(select.value);
    }

    // 3) Carregar resumo de uma campanha
    async function loadSummary(campaignId) {
      const actionsDiv = document.getElementById("actions");
      if (actionsDiv) {
        actionsDiv.innerHTML = "<p class='small'>Carregando resumo...</p>";
      }

      try {
        const res = await fetch(`${API_URL}/api/campaigns/${campaignId}/summary`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          if (actionsDiv) {
            actionsDiv.innerHTML = "<p class='small'>Erro ao carregar resumo da campanha.</p>";
          }
          renderRadarChart([], []);
          return;
        }

        const data = await res.json();
        const averages = data.averages || {};

        const labels = Object.keys(averages);
        const values = Object.values(averages);

        if (labels.length === 0) {
          if (actionsDiv) {
            actionsDiv.innerHTML =
              "<p class='small'>Ainda n√£o h√° respostas para esta campanha.</p>";
          }
          renderRadarChart([], []);
          return;
        }

        // Atualiza gr√°fico radar
        renderRadarChart(labels, values);

        // Atualiza plano de a√ß√£o
        renderActionPlan(labels, values);
      } catch (err) {
        console.error(err);
        if (actionsDiv) {
          actionsDiv.innerHTML =
            "<p class='small'>Erro de conex√£o ao buscar resumo.</p>";
        }
        renderRadarChart([], []);
      }
    }

    // 4) Gr√°fico radar (Chart.js)
    function renderRadarChart(labels, values) {
      const ctx = document.getElementById('radar');
      if (!ctx) return;

      if (radarChart) {
        radarChart.destroy();
      }

      if (labels.length === 0) {
        // Se n√£o h√° dados, apenas limpa (n√£o recria gr√°fico vazio)
        return;
      }

      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            label: 'M√©dia (1-5)',
            data: values,
            fill: true
          }]
        },
        options: {
          scales: {
            r: {
              suggestedMin: 1,
              suggestedMax: 5
            }
          }
        }
      });
    }

    // 5) Plano de a√ß√£o com base nas m√©dias
    function renderActionPlan(labels, values) {
      const container = document.getElementById("actions");
      if (!container) return;

      if (!labels.length) {
        container.innerHTML = "<p class='small'>Sem dados ainda para esta campanha.</p>";
        return;
      }

      let html = "";
      labels.forEach((dim, i) => {
        const score = values[i];
        let prioridade = "Manter";
        if (score < 3) prioridade = "Aten√ß√£o";
        else if (score < 3.5) prioridade = "M√©dio";

        html += `
          <div class="card action-card">
            <span class="badge">${prioridade}</span>
            <b>${dim}</b><br>
            <span class="small">
              ${
                prioridade === "Manter"
                  ? "Manter boas pr√°ticas e monitorar com reavalia√ß√µes peri√≥dicas."
                  : "Definir plano de interven√ß√£o e metas de melhoria para esta dimens√£o."
              }
            </span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // 6) Criar nova campanha (formul√°rio)
    async function onCreateCampaign(event) {
      event.preventDefault();

      const companyName = document.getElementById("companyName").value.trim();
      const title = document.getElementById("campaignTitle").value.trim();
      const description = document.getElementById("campaignDescription").value.trim();

      if (!companyName || !title) {
        alert("Preencha empresa e t√≠tulo da campanha.");
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/campaigns`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({
            company_name: companyName,
            title: title,
            description: description
          })
        });

        if (!res.ok) {
          alert("Erro ao criar campanha. Verifique se est√° autenticado.");
          return;
        }

        alert("Campanha criada com sucesso!");
        // Limpa o formul√°rio
        document.getElementById("campaignForm").reset();
        // Recarrega lista de campanhas
        loadCampaigns();
      } catch (err) {
        console.error(err);
        alert("Erro de conex√£o ao criar campanha.");
      }
    }

    // 7) Exportar PDF = usar a impress√£o do navegador
    function exportPdf() {
      window.print();
    }
  </script>
</body>
</html>






