<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Datainsight PsyPro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Mesmo CSS do login -->
  <link rel="stylesheet" href="assets/branding-V2.css">

  <!-- Chart.js para o gráfico radar -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <!-- NAVBAR -->
  <div class="navbar">
    <div class="wrap">
      <div class="logo">
        <img src="assets/datainsight.png" alt="Datainsight SST Consulting">
        <span>DATASINSIGHT PSYPRO</span>
      </div>

      <div class="navbar-right">
        <span id="userBadge" class="badge"></span>
        <button onclick="logout()" class="btn small">Sair</button>
      </div>
    </div>
  </div>

  <!-- CONTEÚDO PRINCIPAL -->
  <div class="container">

    <!-- GRID 2 COLUNAS NO DESKTOP / 1 NO MOBILE -->
    <div class="grid-two">

      <!-- CARD ESQUERDA: Campanhas + Radar -->
      <div class="card">
        <h2>Painel de Campanhas</h2>
        <p class="card-subtitle">
          Selecione uma campanha para visualizar o resumo das dimensões psicossociais.
        </p>

        <div id="status" class="small" style="margin-bottom:10px;"></div>

        <label for="campaignSelect">Campanha:</label>
        <select id="campaignSelect" onchange="onCampaignChange()">
          <option value="">Carregando campanhas...</option>
        </select>

        <!-- Link público da campanha -->
        <div id="publicLink" class="small" style="margin-top:8px;"></div>

        <h3 style="margin-top:20px;">Gráfico Radar (Médias por dimensão)</h3>
        <canvas id="radar" width="400" height="400"></canvas>

        <!-- Botão para exportar PDF -->
        <div style="margin-top:12px;">
          <button type="button" class="btn small" onclick="exportPdf()">
            Exportar PDF
          </button>
        </div>
      </div>

      <!-- CARD DIREITA: Plano de ação + criação de campanha -->
      <div class="card">
        <h2>Plano de Ação & Gestão</h2>
        <p class="card-subtitle">
          As dimensões com menor média aparecem com maior prioridade de intervenção.
        </p>

        <div id="actions" style="margin-bottom:20px;"></div>

        <hr>

        <h3>Criar nova campanha</h3>
        <form id="campaignForm" class="login-form" style="max-width:500px;">
          <label>
            Empresa / Cliente
            <input id="companyName" type="text" placeholder="Ex.: Escola Estadual X, Empresa Y" required>
          </label>

          <label>
            Título da campanha
            <input id="campaignTitle" type="text" placeholder="Ex.: Avaliação NR01 - 1º semestre" required>
          </label>

          <label>
            Descrição (opcional)
            <textarea id="campaignDescription" rows="3" placeholder="Breve descrição da campanha"></textarea>
          </label>

          <button type="submit" class="btn primary">Criar campanha</button>
        </form>
      </div>

    </div> <!-- fim grid-two -->

  </div> <!-- fim container -->

  <div class="footer">
    © 2025 DATASINSIGHT PSYPRO — Acesso Profissional
  </div>

  <!-- JAVASCRIPT -->
  <script>
    // URL da API em produção (Render)
    const API_URL = "https://datainsight-psypro.onrender.com";

    // Recupera token salvo no login
    const token = localStorage.getItem('token');

    // Se não estiver logado, volta pro login
    if (!token) {
      window.location.href = "index.html";
    }

    // Gráfico radar (instância global)
    let radarChart = null;

    // Ao carregar a página
    document.addEventListener("DOMContentLoaded", () => {
      const userName = localStorage.getItem('user_name') || "Usuário";
      const badge = document.getElementById("userBadge");
      if (badge) {
        badge.textContent = userName;
      }

      // Liga o formulário de nova campanha
      const form = document.getElementById("campaignForm");
      if (form) {
        form.addEventListener("submit", onCreateCampaign);
      }

      // Carrega campanhas ao abrir
      loadCampaigns();
    });

    // Botão de sair
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user_name');
      window.location.href = "index.html";
    }

    // Mensagem de status
    function setStatus(msg) {
      const el = document.getElementById("status");
      if (el) el.textContent = msg;
    }

    // Link público da campanha
    async function showPublicLink(campaignId) {
      const el = document.getElementById("publicLink");
      if (!el) return;

      if (!campaignId) {
        el.textContent = "";
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/public/surveys/${campaignId}/link`);
        if (!res.ok) {
          el.textContent = "Não foi possível gerar o link público.";
          return;
        }
        const data = await res.json();
        el.innerHTML = `Link público: <a href="${data.url}" target="_blank">${data.url}</a>`;
      } catch (err) {
        console.error(err);
        el.textContent = "Erro ao carregar link público.";
      }
    }

    // 1) Carregar lista de campanhas
    async function loadCampaigns() {
      setStatus("Carregando campanhas...");

      try {
        const res = await fetch(`${API_URL}/api/campaigns`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          setStatus("Erro ao carregar campanhas. Talvez o login tenha expirado.");
          return;
        }

        const campaigns = await res.json();
        const select = document.getElementById("campaignSelect");

        if (!select) return;

        select.innerHTML = "";

        if (campaigns.length === 0) {
          setStatus("Nenhuma campanha cadastrada ainda.");
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Nenhuma campanha disponível";
          select.appendChild(opt);

          document.getElementById("actions").innerHTML =
            "<p class='small'>Cadastre uma campanha no formulário abaixo para começar.</p>";

          renderRadarChart([], []);
          showPublicLink(null);
          return;
        }

        setStatus(`Foram encontradas ${campaigns.length} campanha(s).`);

        campaigns.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.company_name} — ${c.title}`;
          select.appendChild(opt);
        });

        // Carrega a primeira campanha automaticamente
        const firstId = campaigns[0].id;
        loadSummary(firstId);
        showPublicLink(firstId);
      } catch (err) {
        console.error(err);
        setStatus("Erro de conexão com o servidor. Verifique a API_URL.");
      }
    }

    // 2) Quando trocar a campanha no select
    async function onCampaignChange() {
      const select = document.getElementById("campaignSelect");
      if (!select || !select.value) {
        showPublicLink(null);
        return;
      }
      await loadSummary(select.value);
      showPublicLink(select.value);
    }

    // 3) Carregar resumo de uma campanha
    async function loadSummary(campaignId) {
      const actionsDiv = document.getElementById("actions");
      if (actionsDiv) {
        actionsDiv.innerHTML = "<p class='small'>Carregando resumo...</p>";
      }

      try {
        const res = await fetch(`${API_URL}/api/campaigns/${campaignId}/summary`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          if (actionsDiv) {
            actionsDiv.innerHTML = "<p class='small'>Erro ao carregar resumo da campanha.</p>";
          }
          renderRadarChart([], []);
          return;
        }

        const data = await res.json();
        const averages = data.averages || {};

        const labels = Object.keys(averages);
        const values = Object.values(averages);

        if (labels.length === 0) {
          if (actionsDiv) {
            actionsDiv.innerHTML =
              "<p class='small'>Ainda não há respostas para esta campanha.</p>";
          }
          renderRadarChart([], []);
          return;
        }

        // Atualiza gráfico radar
        renderRadarChart(labels, values);

        // Atualiza plano de ação
        renderActionPlan(labels, values);
      } catch (err) {
        console.error(err);
        if (actionsDiv) {
          actionsDiv.innerHTML =
            "<p class='small'>Erro de conexão ao buscar resumo.</p>";
        }
        renderRadarChart([], []);
      }
    }

    // 4) Gráfico radar (Chart.js)
    function renderRadarChart(labels, values) {
      const ctx = document.getElementById('radar');
      if (!ctx) return;

      if (radarChart) {
        radarChart.destroy();
      }

      if (labels.length === 0) {
        return;
      }

      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Média (1-5)',
            data: values,
            fill: true
          }]
        },
        options: {
          scales: {
            r: {
              suggestedMin: 1,
              suggestedMax: 5
            }
          }
        }
      });
    }

    // 5) Plano de ação com base nas médias
    function renderActionPlan(labels, values) {
      const container = document.getElementById("actions");
      if (!container) return;

      if (!labels.length) {
        container.innerHTML = "<p class='small'>Sem dados ainda para esta campanha.</p>";
        return;
      }

      let html = "";
      labels.forEach((dim, i) => {
        const score = values[i];
        let prioridade = "Manter";
        if (score < 3) prioridade = "Atenção";
        else if (score < 3.5) prioridade = "Médio";

        html += `
          <div class="card action-card">
            <span class="badge">${prioridade}</span>
            <b>${dim}</b><br>
            <span class="small">
              ${
                prioridade === "Manter"
                  ? "Manter boas práticas e monitorar com reavaliações periódicas."
                  : "Definir plano de intervenção e metas de melhoria para esta dimensão."
              }
            </span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // 6) Criar nova campanha (formulário)
    async function onCreateCampaign(event) {
      event.preventDefault();

      const companyName = document.getElementById("companyName").value.trim();
      const title = document.getElementById("campaignTitle").value.trim();
      const description = document.getElementById("campaignDescription").value.trim();

      if (!companyName || !title) {
        alert("Preencha empresa e título da campanha.");
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/campaigns`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({
            company_name: companyName,
            title: title,
            description: description
          })
        });

        if (!res.ok) {
          alert("Erro ao criar campanha. Verifique se está autenticado.");
          return;
        }

        alert("Campanha criada com sucesso!");
        document.getElementById("campaignForm").reset();
        loadCampaigns();
      } catch (err) {
        console.error(err);
        alert("Erro de conexão ao criar campanha.");
      }
    }

    // 7) Exportar PDF = usar impressão do navegador
    function exportPdf() {
      window.print();
    }
  </script>
</body>
</html>








